version: "3.9"

services:
  postgres:
    image: postgres:${POSTGRES_IMAGE_TAG:-16-alpine}
    environment:
      POSTGRES_USER: ${POSTGRES_USER:?POSTGRES_USER is required}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
    ports:
      - "${POSTGRES_HOST_PORT:-5432}:5432"
    volumes:
      - ${POSTGRES_VOLUME_NAME:-postgres-data}:/var/lib/postgresql/data
      - ./docker/postgres:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 10

  redis:
    image: redis:${REDIS_IMAGE_TAG:-7-alpine}
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    ports:
      - "${REDIS_HOST_PORT:-6380}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 10

  user-service:
    build:
      context: ../UserService
      dockerfile: Dockerfile
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      NODE_ENV: ${USER_SERVICE_NODE_ENV:-production}
      HTTP_HOST: 0.0.0.0
      HTTP_PORT: ${USER_SERVICE_HTTP_PORT:-4500}
      GRPC_BIND_ADDRESS: 0.0.0.0:${USER_SERVICE_GRPC_PORT:-50052}
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${USER_SERVICE_DB:-pocketlol_users}?schema=public
      LOG_LEVEL: ${USER_SERVICE_LOG_LEVEL:-info}
      SERVICE_AUTH_TOKEN: ${SERVICE_AUTH_TOKEN:?SERVICE_AUTH_TOKEN is required}
      AUTH_SERVICE_ADDRESS: auth-service:${AUTH_SERVICE_GRPC_PORT:-50051}
      AUTH_SERVICE_TOKEN: ${SERVICE_AUTH_TOKEN:?SERVICE_AUTH_TOKEN is required}
    ports:
      - "${USER_SERVICE_HTTP_HOST_PORT:-4500}:${USER_SERVICE_HTTP_PORT:-4500}"
      - "${USER_SERVICE_GRPC_HOST_PORT:-50052}:${USER_SERVICE_GRPC_PORT:-50052}"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -fsS http://localhost:4500/health >/dev/null || exit 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  auth-service:
    build:
      context: ../AuthService
      dockerfile: Dockerfile
    depends_on:
      postgres:
        condition: service_healthy
      user-service:
        condition: service_healthy
    environment:
      NODE_ENV: ${AUTH_SERVICE_NODE_ENV:-production}
      HTTP_HOST: 0.0.0.0
      HTTP_PORT: ${AUTH_SERVICE_HTTP_PORT:-4000}
      GRPC_BIND_ADDRESS: 0.0.0.0:${AUTH_SERVICE_GRPC_PORT:-50051}
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${AUTH_SERVICE_DB:-pocketlol_auth}?schema=public
      AUTH_JWT_PRIVATE_KEY: ${AUTH_JWT_PRIVATE_KEY:?AUTH_JWT_PRIVATE_KEY is required}
      AUTH_JWT_PUBLIC_KEY: ${AUTH_JWT_PUBLIC_KEY:?AUTH_JWT_PUBLIC_KEY is required}
      AUTH_JWT_KEY_ID: ${AUTH_JWT_KEY_ID:?AUTH_JWT_KEY_ID is required}
      ACCESS_TOKEN_TTL: ${AUTH_ACCESS_TOKEN_TTL:-900}
      REFRESH_TOKEN_TTL: ${AUTH_REFRESH_TOKEN_TTL:-604800}
      REFRESH_TOKEN_ROTATION: ${AUTH_REFRESH_TOKEN_ROTATION:-true}
      SERVICE_AUTH_TOKEN: ${SERVICE_AUTH_TOKEN:?SERVICE_AUTH_TOKEN is required}
      USER_SERVICE_ADDRESS: user-service:${USER_SERVICE_GRPC_PORT:-50052}
      USER_SERVICE_TOKEN: ${SERVICE_AUTH_TOKEN:?SERVICE_AUTH_TOKEN is required}
      LOG_LEVEL: ${AUTH_SERVICE_LOG_LEVEL:-info}
    ports:
      - "${AUTH_SERVICE_HTTP_HOST_PORT:-4000}:${AUTH_SERVICE_HTTP_PORT:-4000}"
      - "${AUTH_SERVICE_GRPC_HOST_PORT:-50051}:${AUTH_SERVICE_GRPC_PORT:-50051}"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -fsS http://localhost:4000/health >/dev/null || exit 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  api-gateway:
    build:
      context: ../APIGW
      dockerfile: Dockerfile
    depends_on:
      redis:
        condition: service_healthy
      auth-service:
        condition: service_healthy
      user-service:
        condition: service_healthy
    environment:
      NODE_ENV: ${GATEWAY_NODE_ENV:-production}
      SERVER_HOST: 0.0.0.0
      SERVER_PORT: ${GATEWAY_HTTP_PORT:-3000}
      SERVER_BODY_LIMIT: ${GATEWAY_BODY_LIMIT:-1048576}
      SERVER_TRUST_PROXY: ${GATEWAY_TRUST_PROXY:-true}
      LOG_LEVEL: ${GATEWAY_LOG_LEVEL:-info}
      ENABLE_REQUEST_LOGGING: ${GATEWAY_REQUEST_LOGGING:-true}
      REDIS_URL: redis://redis:6379
      RATE_LIMIT_ANON: ${GATEWAY_RATE_LIMIT_ANON:-20}
      RATE_LIMIT_AUTH: ${GATEWAY_RATE_LIMIT_AUTH:-100}
      RATE_LIMIT_ADMIN: ${GATEWAY_RATE_LIMIT_ADMIN:-500}
      AUTH_JWKS_URL: http://auth-service:${AUTH_SERVICE_HTTP_PORT:-4000}/.well-known/jwks.json
      AUTH_AUDIENCE: ${GATEWAY_AUTH_AUDIENCE:-pocketlol-services}
      AUTH_ISSUER: ${GATEWAY_AUTH_ISSUER:-auth-service}
      CONTENT_CACHE_TTL_SECONDS: ${GATEWAY_CONTENT_CACHE_TTL:-120}
      STREAMING_SERVICE_URL: ${STREAMING_SERVICE_URL:-http://mock-streaming:3000}
      CONTENT_SERVICE_URL: ${CONTENT_SERVICE_URL:-http://mock-content:3000}
      AUTH_SERVICE_URL: http://auth-service:${AUTH_SERVICE_HTTP_PORT:-4000}
      USER_SERVICE_URL: http://user-service:${USER_SERVICE_HTTP_PORT:-4500}
      UPLOAD_SERVICE_URL: ${UPLOAD_SERVICE_URL:-http://mock-upload:3000}
      ENGAGEMENT_SERVICE_URL: ${ENGAGEMENT_SERVICE_URL:-http://mock-engagement:3000}
      SEARCH_SERVICE_URL: ${SEARCH_SERVICE_URL:-http://mock-search:3000}
      SERVICE_AUTH_TOKEN: ${SERVICE_AUTH_TOKEN:?SERVICE_AUTH_TOKEN is required}
      ENABLE_TELEMETRY: ${GATEWAY_ENABLE_TELEMETRY:-false}
      SERVICE_NAME: ${GATEWAY_SERVICE_NAME:-pocketlol-gateway}
    ports:
      - "${GATEWAY_HTTP_HOST_PORT:-3000}:${GATEWAY_HTTP_PORT:-3000}"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -fsS http://localhost:3000/health/live >/dev/null || exit 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

volumes:
  postgres-data:
