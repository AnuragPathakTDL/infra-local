services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./docker/postgres:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 10

  redis:
    image: redis:7-alpine
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    ports:
      - "6380:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 10

  user-service:
    build:
      context: ../UserService
      dockerfile: Dockerfile
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      NODE_ENV: production
      HTTP_HOST: 0.0.0.0
      HTTP_PORT: 4500
      GRPC_BIND_ADDRESS: 0.0.0.0:50052
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/pocketlol_users?schema=public
      LOG_LEVEL: info
      SERVICE_AUTH_TOKEN: dev-service-token
    ports:
      - "4500:4500"
      - "50052:50052"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -fsS http://localhost:4500/health >/dev/null || exit 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  auth-service:
    build:
      context: ../AuthService
      dockerfile: Dockerfile
    depends_on:
      postgres:
        condition: service_healthy
      user-service:
        condition: service_healthy
    environment:
      NODE_ENV: production
      HTTP_HOST: 0.0.0.0
      HTTP_PORT: 4000
      GRPC_BIND_ADDRESS: 0.0.0.0:50051
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/pocketlol_auth?schema=public
      AUTH_JWT_PRIVATE_KEY: |
        -----BEGIN PRIVATE KEY-----
        MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC/b6P1NXvUMKB/
        BEYelrQHaTDoc7S48fAiEITGjJ2IjwsADcrI10omAyDpb1CVAiw53o2f7aMR08fK
        uBI+zm1yKSd6DKObri3wQ175pMOitqUPPLUEFgWGK+PDv7qnyvAsdvTDSJ41SLIf
        onneZ8ejNohz+ZGoNJ3IFFuI835UfNqQsDZnx0AIufeevvuDIrj8UoDR2nziWOov
        6WJuVJYhAyyEdxJCKreZKyjGg6+do1/Tyt+mO2Vg6ZGuQbbjNKR0+0xv58NZhiPI
        DkosywKrA1vJCmSl01miwuR1mM1AAH9yRUqFybGMAJtXgBKcnc/AOFDqN03H3ug8
        XUrX7ZNVAgMBAAECggEAK71YWuhzeJH7ucnCM67/R0ozkIkPW8p7sWzQyYTLYa49
        Ny/vi2AVYwYH+Q4j/UfXzwkYltf3EFWxKpJQKOWFgDYC/RHyN9neSS07gBKzWHQe
        1pJqUZqufG9+xPUDst7dbWtolU38R/RqLmwzKCvSI2qMVuNI8oPDITn1iB8KWEch
        Xnn8VPJWRVCeBp8/xtwrHRef5cVbGeTF0RORhS57FseXl1BrC/urP9KN6vbt1O/B
        ngsYac7k9QpXlxoF0jlhUG2zcOOtoxsLYsxJ0OhOU225UE+/2SF7NTqCvIkxRegh
        B1TkF9He+rOeZCwzo9QNJKHW0UMlu6wHCJ6CVMbOqQKBgQDqNexwDyPhRnT0Rm4W
        scc0N3etgguERXfyjtz1K+slwXreXcIKKajVO6B7MACFqxHVTrLeA19kj9i3Tf/a
        WjuMcgWGwfaUZ+714ajvUv9RaZvwEwu/KmeGgkYuUCLpr+7Drr2nHRkpP4Era5Wi
        gb+keB3LhsSNWyFAC1VPxrs5PwKBgQDRPvopUWC9/b/g249BGg1JUheAGOhuAkMS
        IYVJlW517M37xAbzb8EwGAgRGLzMiSAmIkPVYCCUmSOC67xKFXvsLg8/dqIwgM/L
        OQuFOqlGCDLsI0GPAKWjfAaK3/K6t8+xCVo9iXscI0kWIqXijAz2Tj3RNXW1mxwv
        /lTUVtPaawKBgEC/o5vfM6Yl2lNl3S18/HtdEkLvfsuUgPKXuFI3UAziDlvHQ8uX
        dMtubpFf1eUeRBHabeyethKRCfKzJ5Zv96J+KzT0Dn08tn1XY2K2aUtSjP+z5D13
        NaOkBE7tbJl6P+HtPxUiIECdA9LDLVz9zcNkSahom5IQrYKNH4qsgDn1AoGAWdN1
        ROOAak9SXc8jckkixwUMvZrzvLYP4Oqu82XI46riyl/etAaXonPOkrhR5GRBft1a
        zXDUy7Xp/rwAOrV6W2tydEYTXksN6Sn1/h2uqTe/1ItWC3O1p7cIf/mfk/Rwnolr
        SduJFA05xNze5aBFuD7iXrtaarnJofjGpdkYXT0CgYEAwatOp0bGea5gc4yNsQoF
        9DrMpotCDDonTurV/gID2NtWrG1LvFhx5E2/Qw19GuNYBfTmeH3jxalYEWkAWgyC
        TdHb0inrj3bre3AeAO31bbBD5dgClFDJJcmyM+piEUbDTobqiOOnMo3hsrPTG5eE
        UV73uF7/hlqFQ3mymsjOS4Y=
        -----END PRIVATE KEY-----
      AUTH_JWT_PUBLIC_KEY: |
        -----BEGIN PUBLIC KEY-----
        MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAv2+j9TV71DCgfwRGHpa0
        B2kw6HO0uPHwIhCExoydiI8LAA3KyNdKJgMg6W9QlQIsOd6Nn+2jEdPHyrgSPs5t
        ciknegyjm64t8ENe+aTDoralDzy1BBYFhivjw7+6p8rwLHb0w0ieNUiyH6J53mfH
        ozaIc/mRqDSdyBRbiPN+VHzakLA2Z8dACLn3nr77gyK4/FKA0dp84ljqL+liblSW
        IQMshHcSQiq3mSsoxoOvnaNf08rfpjtlYOmRrkG24zSkdPtMb+fDWYYjyA5KLMsC
        qwNbyQpkpdNZosLkdZjNQAB/ckVKhcmxjACbV4ASnJ3PwDhQ6jdNx97oPF1K1+2T
        VQIDAQAB
        -----END PUBLIC KEY-----
      AUTH_JWT_KEY_ID: auth-service-dev
      ACCESS_TOKEN_TTL: 900
      REFRESH_TOKEN_TTL: 604800
      REFRESH_TOKEN_ROTATION: "true"
      SERVICE_AUTH_TOKEN: dev-service-token
      USER_SERVICE_ADDRESS: user-service:50052
      USER_SERVICE_TOKEN: dev-service-token
      LOG_LEVEL: info
    ports:
      - "4000:4000"
      - "50051:50051"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -fsS http://localhost:4000/health >/dev/null || exit 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  api-gateway:
    build:
      context: ../APIGW
      dockerfile: Dockerfile
    depends_on:
      redis:
        condition: service_healthy
      auth-service:
        condition: service_healthy
      user-service:
        condition: service_healthy
    environment:
      NODE_ENV: production
      SERVER_HOST: 0.0.0.0
      SERVER_PORT: 3000
      SERVER_BODY_LIMIT: 1048576
      SERVER_TRUST_PROXY: "true"
      LOG_LEVEL: info
      ENABLE_REQUEST_LOGGING: "true"
      REDIS_URL: redis://redis:6379
      RATE_LIMIT_ANON: 20
      RATE_LIMIT_AUTH: 100
      RATE_LIMIT_ADMIN: 500
      AUTH_JWKS_URL: http://auth-service:4000/.well-known/jwks.json
      AUTH_AUDIENCE: pocketlol-services
      AUTH_ISSUER: auth-service
      CONTENT_CACHE_TTL_SECONDS: 120
      STREAMING_SERVICE_URL: http://mock-streaming:3000
      CONTENT_SERVICE_URL: http://mock-content:3000
      AUTH_SERVICE_URL: http://auth-service:4000
      USER_SERVICE_URL: http://user-service:4500
      UPLOAD_SERVICE_URL: http://mock-upload:3000
      ENGAGEMENT_SERVICE_URL: http://mock-engagement:3000
      SEARCH_SERVICE_URL: http://mock-search:3000
      SERVICE_AUTH_TOKEN: dev-service-token
      ENABLE_TELEMETRY: "false"
      SERVICE_NAME: pocketlol-gateway
    ports:
      - "3000:3000"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -fsS http://localhost:3000/health/live >/dev/null || exit 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

volumes:
  postgres-data:
